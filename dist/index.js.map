{"version":3,"file":"index.js","sources":["../src/index.tsx"],"sourcesContent":["let globalrouter: Router | null = null;\n\nexport class Router {\n  private el: HTMLElement = null!;\n\n  constructor(private root: ComponentElement<typeof Route>) {\n    if (globalrouter) {\n      throw new Error(\"Only one router can be created\");\n    }\n\n    globalrouter = this;\n\n    (window as any).r = globalrouter;\n  }\n\n  public navigate(path: string): boolean {\n    history.pushState(null, \"\", path);\n    return this.route(path);\n  }\n\n  public route(path: string): boolean {\n    if (this.root.$.path) throw new Error(\"Root route cannot have a path\");\n\n    let url = new URL(path, location.origin);\n\n    path = url.pathname;\n\n    if (path[0] == \"/\") path = path.slice(1);\n\n    return this.subroute(path, path, this.root)!;\n  }\n\n\n  private subroute(path: string, subpath: string, root: ComponentElement<typeof Route>): boolean | null {\n    match: for (let route of root.$.children) {\n      let routepath = route.$.path;\n      if (typeof routepath !== \"string\") throw new Error(\"Route must have a path\");\n      if (routepath[0] == \"/\") routepath = routepath.slice(1);\n\n      let splitpath = subpath.split(\"/\");\n      let splittarget = routepath.split(\"/\");\n\n\n      let urlparams: Record<string, string> = {};\n\n      while (true) {\n        let pathpart = splitpath.shift();\n        let target = splittarget.shift();\n\n        // both empty => exact match\n        if (!pathpart && !target) break;\n\n        // matched fully, but there's more url to go => try to match children\n        if (!target && pathpart && route.$.children.length > 0) {\n          splitpath.unshift(pathpart);\n          break;\n        }\n\n        // only a partial match of target => no match\n        if (!pathpart || !target) continue match;\n\n\n        if (target.startsWith(\":\")) {\n          let varname = target.slice(1);\n          urlparams[varname] = pathpart;\n        } else if (target.startsWith(\"*\")) {\n          // don't check the rest of the path\n          break;\n        } else if (pathpart != target) {\n          continue match;\n        }\n      }\n\n      if (route.$ instanceof Redirect) {\n        let a = document.createElement(\"a\");\n        let to = route.$.to;\n        if (typeof to == \"function\") to = to(path, urlparams);\n        a.href = to;\n\n        this.navigate(a.pathname + a.search);\n\n        // cancel\n        return null;\n      }\n\n      if (route.$.children.length > 0) {\n        // if child 404s start matching back from parent\n\n        let res = this.subroute(path, splitpath.join(\"/\"), route as ComponentElement<typeof Route>);\n        if (res === null) return null;\n\n        if (!res) continue match;\n      }\n\n      // if we got here, we have a match\n      let show = route.$.show;\n      if (typeof show == \"function\") show = show(path, urlparams);\n\n      if (!show) throw new Error(`Route ${route.$.path} has no show target`);\n\n\n      if (\"$\" in show) {\n        for (let key in urlparams) {\n          show.$[key] = urlparams[key];\n        }\n\n        show.$.routeshown = true;\n        if (show.$.routeshow)\n          show.$.routeshow(path);\n      }\n\n      for (let otherroute of root.$.children) {\n        if (otherroute.$ instanceof Redirect) continue;\n\n        if (!otherroute.$.show) throw new Error(`Route ${otherroute.$.path} has no show target`);\n        if (\"$\" in otherroute.$.show && otherroute.$.show != show) {\n          otherroute.$.show.$.routeshown = false;\n          if (otherroute.$.show.$.routehide)\n            otherroute.$.show.$.routehide();\n        }\n      }\n\n      if (root == this.root && !this.root.$.show) {\n        this.el.replaceWith(show);\n      } else {\n        let parentshow = root.$.show\n        if (!(\"$\" in parentshow!)) throw new Error(\"If subroutes are specified, show target must be a functional component\");\n\n        parentshow.$.outlet = show;\n      }\n\n      return true;\n    }\n\n    return false;\n  }\n\n  public mount(root: HTMLElement) {\n\n    if (this.root.$.show) {\n      let show = this.root.$.show;\n      if (typeof show == \"function\") show = show(location.pathname, {});\n      this.el = show;\n    } else {\n      this.el = <temporary />;\n    }\n\n    root.append(this.el);\n    this.route(location.pathname + location.search);\n\n    window.addEventListener(\"popstate\", () => {\n      this.route(location.pathname + location.search);\n    });\n\n  }\n\n\n}\n\ntype ShowTarget = DLElement<{\n  outlet?: HTMLElement\n  routeshow?: (path: string) => void\n  routehide?: () => void\n  routeshown: boolean\n\n  [index: string]: any\n}> | HTMLElement\n\nexport const Route: Component<{\n  path?: string;\n  show?: ShowTarget | ((path: string, params: Record<string, string>) => ShowTarget)\n}, {}, {\n  children: (ComponentElement<typeof Route> | ComponentElement<typeof Redirect>)[]\n}> = function() {\n  // exists only to collect data\n  return <div />;\n}\n\nexport const Redirect: Component<{\n  path: string;\n  to: string | ((path: string) => string);\n}> = function() {\n\n  return <div />;\n}\n\nexport const Link: Component<{\n  href: string;\n  class?: string;\n}, {\n  _leak: true\n  root: HTMLAnchorElement\n  children: any\n}> = function() {\n  this._leak = true;\n\n  return <a href={this.href} class={use(this.class)}\n    on:click={e => {\n      e.preventDefault();\n      if (!globalrouter) throw new Error(\"No router exists\");\n      globalrouter.navigate(this.root.href);\n    }}>{this.children}</a>\n}\n"],"names":[],"mappings":"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"}